<HTML>
<HEAD>
<TITLE>2.23.1 Sequence number protocol</TITLE>
<LINK REL="ToC" HREF="httoc.htm">
<LINK REL="Index" HREF="htindex.htm">
<LINK REL="Next" HREF="ch200120.htm">
<LINK REL="Previous" HREF="ch200118.htm"></HEAD>
<BODY BACKGROUND="images/grenszig.gif">
<P ALIGN=LEFT>
<A HREF="ch200118.htm" TARGET="_self"><IMG SRC="images/blrprev.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Previous Page"></A>
<A HREF="httoc.htm" TARGET="_self"><IMG SRC="images/blrtoc.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="TOC"></A>
<A HREF="htindex.htm" TARGET="_self"><IMG SRC="images/blrindex.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Index"></A>
<A HREF="ch200120.htm" TARGET="_self"><IMG SRC="images/blrnext.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Next Page"></A>
<P>

<A NAME="E12E105"></A>
<H3><B>2.23.1</B><B> </B><A NAME="I2"></A><A NAME="I3"></A><A NAME="I4"></A><A NAME="I5"></A><A NAME="I6"></A><A NAME="I7"></A><A NAME="I8"></A><A NAME="I9"></A><A NAME="I10"></A><A NAME="I11"></A><A NAME="I12"></A><A NAME="I13"></A><A NAME="I14"></A><A NAME="I15"></A><A NAME="I16"></A><A NAME="I17"></A><B>Sequence number protocol</B><A NAME="I18"></A><A NAME="I19"></A></H3>
<P>
<FONT FACE="Times New Roman">For certain types of data transactions between systems the issue of keeping databases synchronized is critical.  An example is an ancillary system such as lab, which needs to know the locations of all inpatients to route stat results correctly.  If the lab receives an ADT transaction out of sequence, the census/location information may be incorrect.  Although it is true that a simple one-to-one acknowledgment scheme can prevent out-of-sequence transactions between any two systems, only the use of sequence numbers can prevent duplicate transactions.  </FONT>

<TABLE BORDER=1 CELLSPACING=1 >
<TR>
<TD WIDTH=560 VALIGN=top >
<P>
<FONT FACE="Arial Narrow" SIZE="-1"><B>Note:</B>  Although this sequence number protocol is limited to the use of sequence numbers on a single transaction stream between two applications, this sequencing protocol is sufficiently robust to allow the design of HL7-compatible store-and-forward applications.</TD></TR></FONT></TABLE><P>
<FONT FACE="Times New Roman">a) definitions, initial conditions:</FONT>
<P>
<FONT FACE="Times New Roman">1) the system receiving the data stream is expected to store the sequence number of the most recently accepted transaction in a secure fashion before acknowledging that transaction. This stored sequence number allows comparison with the next transaction&#146;s sequence number, and the implementation of fault-tolerant restart capabilities.</FONT>
<P>
<FONT FACE="Times New Roman">2) the initiating system keeps a queue of outgoing transactions indexed by the sequence number.  The length of this queue must be negotiated as part of the design process for a given link.  The minimum length for this queue is one.</FONT>
<P>
<FONT FACE="Times New Roman">3) the sequence number is a positive (non-zero) integer; and it is incremented by one (by the initiating system) for each successive transaction. </FONT>
<P>
<FONT FACE="Times New Roman">b) starting the link:</FONT>
<P>
<FONT FACE="Times New Roman">1) the value of 0 (zero) for a sequence number is reserved: it is allowed only when the initiating system (re-)starts the link.</FONT>
<P>
<FONT FACE="Times New Roman">2) if the receiving system gets a transaction with a 0 (zero) in the sequence number field, it should respond with a general acknowledgment message whose MSA contains a sequence number one greater than the sequence number of the last transaction it accepted in the Expected Sequence Number field.  If this value does not exist (as on the first startup of a given link), the MSA should contain a sequence number of -1, meaning that the receiving system will use the positive, non-zero sequence number of the first transaction it accepts as its initial sequence number (see resynching the link, item e below). </FONT>
<P>
<FONT FACE="Times New Roman">3) the initiating system then sends the transaction indexed by the expected sequence number (if that expected transaction is still on its queue).  Otherwise the link is frozen until an operator intervenes.</FONT>
<P>
<FONT FACE="Times New Roman">c) normal operation of the link:</FONT>
<P>
<FONT FACE="Times New Roman">As it accepts each transaction, the receiving system securely stores the sequence number (which agrees with its expected sequence number), and then acknowledges the message by echoing the sequence number in <I>MSA-4-expected sequence number</I>.</FONT>
<P>
<FONT FACE="Times New Roman">d) error conditions (from point of view of initiating system).  These are generated by the receiving system, by its comparison of the sequence number sent out (with the MSH in <I>MSH-13-sequence </I><I>number</I>) with the expected sequence number (<I>MSA-4-expected sequence number</I> received with the MSA).</FONT>
<P>
<FONT FACE="Times New Roman">1) expected sequence number is one greater than current value.  The previous acknowledgment was lost.  That transaction was sent again.  Correct by sending next transaction.</FONT>
<P>
<FONT FACE="Times New Roman">2) expected sequence number less than current value. Initiating system can try starting again by issuing a transaction with a sequence number of zero; or freeze the link for operator intervention.</FONT>
<P>
<FONT FACE="Times New Roman">3) other errors: freeze the link for operator intervention</FONT>
<P>
<FONT FACE="Times New Roman">e) forcing resynchronization of sequence numbers across the link.  The value of -1 for a sequence number is reserved: it is allowed only when the initiating system is resynching the link.  Thus if the receiving system gets a value of -1 in the sequence number field, it should return a general acknowledgment message with a -1 in the expected sequence number field.  The receiving system then resets its sequence number, using the non-zero positive sequence number of the next transaction it accepts.</FONT>
<P>
<FONT FACE="Times New Roman">f) notes</FONT>
<P>
<FONT FACE="Times New Roman">When the initiating system sends a message with a sequence number of 0 or -1 (see b or e above), the segments beyond the MSH need not be present in the message, or, if present, all fields can be null.  In terms of the responding system, for these two cases, only a General acknowledgment message is needed.</FONT>
<P>
<P ALIGN=LEFT>
<A HREF="ch200118.htm" TARGET="_self"><IMG SRC="images/blrprev.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Previous Page"></A>
<A HREF="httoc.htm" TARGET="_self"><IMG SRC="images/blrtoc.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="TOC"></A>
<A HREF="htindex.htm" TARGET="_self"><IMG SRC="images/blrindex.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Index"></A>
<A HREF="ch200120.htm" TARGET="_self"><IMG SRC="images/blrnext.gif" WIDTH = 32 HEIGHT = 32 BORDER = 0 ALT="Next Page"></A>
</BODY></HTML>
