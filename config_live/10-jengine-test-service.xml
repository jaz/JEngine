<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE server>

<server>

 	<!--
		jEngine Queue Definitions
		drop into server/default/deploy/jms
	-->
  
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=Queue,name=Q_IN_HL7_MS4_MT_ADT">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=Queue,name=Q_IN_HL7_MS4_MT_ADT_FILTER">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=Queue,name=Q_IN_HL7_MT_MS4_CHG_FILTER">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=ExternalQueue,name=Q_OUT_HL7_MS4_MT_ADT">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=Queue,name=Q_IN_HL7_MT_MS4_CHG">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue"
	 name="JEngine:service=ExternalQueue,name=Q_OUT_HL7_MT_MS4_CHG">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue" name="JEngine:service=ExternalQueue,name=Q_ERROR_OUT_HL7_MS4">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>
  <mbean code="org.jboss.mq.server.jmx.Queue" name="JEngine:service=ExternalQueue,name=Q_ERROR_OUT_HL7_MT">
       <depends optional-attribute-name="DestinationManager">jboss.mq:service=DestinationManager</depends>
  </mbean>

   <mbean code="org.jengine.mbean.HL7ServerService" name="JEngine:service=ExternalInterface,name=TCP_IN_HL7_MS4">
<!--	<attribute name="Comment">Inbound ADT HL7 from MS4 (Cascade)</attribute> -->
	<attribute name="Port">9000</attribute>
       	<attribute name="IFName">TCP_IN_HL7_MS4</attribute>
       	<attribute name="Queues">Q_IN_HL7_MS4_MT_ADT_FILTER</attribute>
   </mbean>

   <mbean code="org.jengine.mbean.HL7ServerService" name="JEngine:service=ExternalInterface,name=TCP_IN_HL7_MT">
<!--	<attribute name="Comment">Inbound Charges HL7 from MediTech</attribute> -->
	<attribute name="Port">9001</attribute>
       	<attribute name="IFName">TCP_IN_HL7_MT</attribute>
       	<attribute name="Queues">Q_IN_HL7_MT_MS4_CHG_FILTER</attribute>
   </mbean>

   <mbean code="org.jengine.mbean.HL7ClientService" name="JEngine:service=ExternalInterface,name=TCP_OUT_HL7_MS4">
<!--        <attribute name="Comment">Outbound Charges HL7 to MS4 (Cascade)</attribute> -->
        <attribute name="Port">9001</attribute>
        <attribute name="IFName">TCP_OUT_HL7_MS4</attribute>
        <attribute name="IPAddress">172.16.18.11</attribute>
        <!-- if xlate is enabled
        <attribute name="Queue">Q_OUT_HL7_MT_MS4_CHG</attribute>
        -->
        <attribute name="Queue">Q_OUT_HL7_MT_MS4_CHG</attribute>
        <attribute name="QueueError">Q_ERROR_OUT_HL7_MS4</attribute>
        <attribute name="ResendFailedCount">10</attribute>
        <attribute name="ResendRetryInterval">60000</attribute>
        <attribute name="ConnectRetryInterval">20000</attribute>
        <attribute name="ConnectRetryInterval">20000</attribute>
   </mbean>

   <mbean code="org.jengine.mbean.HL7ClientService" name="JEngine:service=ExternalInterface,name=TCP_OUT_HL7_MT">
<!--        <attribute name="Comment">Outbound ADT HL7 to MediTech</attribute> -->
        <attribute name="Port">6000</attribute>
        <attribute name="IFName">TCP_OUT_HL7_MT</attribute>
        <attribute name="IPAddress">10.10.0.71</attribute>
        <attribute name="Queue">Q_OUT_HL7_MS4_MT_ADT</attribute>
        <attribute name="QueueError">Q_ERROR_OUT_HL7_MT</attribute>
        <attribute name="ResendFailedCount">10</attribute>
        <attribute name="ResendRetryInterval">30000</attribute>
        <attribute name="ConnectRetryInterval">20000</attribute>
   </mbean>

   <mbean code="org.jengine.mbean.HL7FilterService" name="JEngine:service=Interface,name=FILTER_ADT_MS4_MT">
        <attribute name="IFName">FILTER_ADT_MS4_MT</attribute>
       	<attribute name="InQueue">Q_IN_HL7_MS4_MT_ADT_FILTER</attribute>
       	<attribute name="OutQueue">Q_IN_HL7_MS4_MT_ADT</attribute>
        <attribute name="FilterClass">org.jengine.internal.bsh.Filter</attribute>
        <attribute name="FilterProperties">
           import org.jengine.tools.hl7.Message;
           import org.jengine.tools.hl7.Segment;
           import org.jengine.tools.hl7.Field;
           
	   log.info("Filter in progress");
	   log.info("version is "+message.versionID);
           Segment evnSegment;
           String eventTypeCode, patientClass;
           try {
               evnSegment = message.getSegment("EVN");
           } catch (Exception e)
           { log.error("**** EVN missing ****"); }

           eventTypeCodeField = evnSegment.getField(1);
           eventTypeCode = eventTypeCodeField.get(1);

           //if (eventTypeCode.equalsIgnoreCase("A05"))
           //{
             //log.info("***********A05___eventTypeCode___KILL*************");
             //Field fld = new Field("KILL");
             //message.messageType = fld;
           //}
           
        </attribute>
   </mbean>
   
   <mbean code="org.jengine.mbean.HL7FilterService" name="JEngine:service=Interface,name=FILTER_CHG_MT_MS4">
        <attribute name="IFName">FILTER_CHG_MT_MS4</attribute>
       	<attribute name="InQueue">Q_IN_HL7_MT_MS4_CHG_FILTER</attribute>
       	<attribute name="OutQueue">Q_IN_HL7_MT_MS4_CHG</attribute>
        <attribute name="FilterClass">org.jengine.internal.bsh.Filter</attribute>
        <attribute name="FilterProperties">
           import org.jengine.tools.hl7.Segment;
           import org.jengine.tools.hl7.Field;
           
	   log.info("Filter in progress");
	   log.info("version is "+message.versionID);
           Segment bhsSegment;
           try {
               bhsSegment = message.getSegment("BHS");
           } catch (Exception e)
           { log.error("**** BHS missing ****"); }

           if (bhsSegment == null)
           {
             log.info("***********MalformedCHARGE____MissingBHS______KILL*************");
             Field fld = new Field("KILL");
             message.messageType = fld;
           }

     	</attribute>
   </mbean>

      <mbean code="org.jengine.mbean.HL7XformService" name="JEngine:service=Interface,name=XFORM_ADT_MS4_MT">
        <attribute name="IFName">XFORM_ADT_MS4_MT</attribute>
       	<attribute name="InQueue">Q_IN_HL7_MS4_MT_ADT</attribute>
       	<attribute name="OutQueue">Q_OUT_HL7_MS4_MT_ADT</attribute>
        <attribute name="Transformation">org.jengine.internal.bsh.Transformation</attribute>
        <attribute name="TransformationProperties">
        
//NOTES ON BEANSHELL IN THIS XML FILE
// do NOT use ampersands in code, USE nested ifs
// or use "&amp;" instead
// do NOT use greater than or less than signs, USE !
import org.jengine.tools.hl7.Segment;
import org.jengine.tools.hl7.Field;

log.info("transformation in progress");
log.info("version is "+message.versionID);
Segment pv1Segment;
Segment evnSegment;
Segment pidSegment;
Segment gt1Segment;
Segment mrgSegment;
String eventTypeCode, patientClass;
try {
    pidSegment = message.getSegment("PID");
    pv1Segment = message.getSegment("PV1");
    evnSegment = message.getSegment("EVN");
    gt1Segment = message.getSegment("GT1");
    mrgSegment = message.getSegment("MRG");
    log.info("Got PID,PV1,EVN,GT1,MRG Segments");
} catch (Exception e)
{ log.error("**** PID, PV1, EVN, GT1 missing ****"); }

eventTypeCodeField = evnSegment.getField(1);
eventTypeCode = eventTypeCodeField.get(1);
patientClassField = pv1Segment.getField(2);
patientClass = patientClassField.get(1);
Field patientTypeField = pv1Segment.getField(18);
String originalPatientType = patientTypeField.get(1);

//*************************
//EVENT TYPE MAPPING, allow outpatient into bed :
//  PV1-40 + MSH-8 -->> MSH-8,EVN-1,PV1-3.5,PV1-40
//*************************
Field bedStatusField = pv1Segment.getField(40);
String bedStatus = null;

try {
    log.info("Try to get bedStatus");
    //if ((bedstatusField != null) &amp;&amp; !bedstatusField.equals("")) {
    if ((bedstatusField != null)) {
        bedStatus = bedStatusField.get(1);
    }
    eventTypeCodeField = evnSegment.getField(1);
    if (eventTypeCodeField != null) {
        eventTypeCode = eventTypeCodeField.get(1);
    }
} catch (Exception e)
{ log.error("Exception in getting bedStatus OR eventTypeCode"); e.printStackTrace(); }

log.info("***GOT bedStatus");

try {
    //NEW CODE TO CHANGE A HOLD go bed 1A in HOLD location
    //TRANSFER
    if (eventTypeCode != null) {
        if (eventTypeCode.equalsIgnoreCase("A02") == true) {
            Field bedField = pv1Segment.getField(6);
            String bed = bedField.get(1);
            if ((bed != null) &amp;&amp; (bed.equalsIgnoreCase("HOLD") == true)) {
                log.info("A02 :: GOT A ***HOLD*** BED :: set to SDSI");
                Field location = pv1Segment.getField(6);
                location.set(1,1,"SDSI");
            }
        }
    }
    // END --- NEW CODE TO CHANGE A HOLD go bed 1A in HOLD location
    // TRANSFER
    
    if (eventTypeCode != null) {
        if (eventTypeCode.equalsIgnoreCase("A01") == true) {
            //NEW CODE TO CHANGE A HOLD go bed 1A in HOLD location
            Field bedField = pv1Segment.getField(3);
            String bed = bedField.get(1);
            if ((bed != null) &amp;&amp; (bed.equalsIgnoreCase("HOLD") == true)) {
                log.info("A01 :: GOT A ***HOLD*** BED :: set to SDSI");
                Field location = pv1Segment.getField(3);
                location.set(1,1,"SDSI");
            }
            // END --- NEW CODE TO CHANGE A HOLD go bed 1A in HOLD location
            
            if ((patientClass != null) &amp;&amp; (patientClass.equalsIgnoreCase("O") == true)) {
                if ((bedStatus != null) &amp;&amp; (bedStatus.equalsIgnoreCase("OBSRV") == true)) {
                    if ((originalPatientType != null) &amp;&amp; (originalPatientType.equalsIgnoreCase("D") != true)) {
                        String eventString = "A04";
                        String bedString = "OCCPD";
                        
                        //set location status
                        Field location = pv1Segment.getField(3);
                        location.set(1,5,bedString);
                        
                        //set bed status
                        Field newBedStatus = new Field(bedString);
                        pv1Segment.setField(40,newBedStatus);
                        
                        //set trigger event, in MSH
                        Field mt = new Field("ADT^A04");
                        message.messageType = mt;
                        //Field triggerEvent = mshSegment.getField(9);
                        //triggerEvent.set(1,2,eventString);
                        
                        //set event type code
                        Field f = new Field(eventString);
                        evnSegment.setField(1,f);
                        eventTypeCode = eventString;
                    }
                }
            }
        }
    }
} catch (Exception e)
{ log.error("Exception in mapping event type MSH-8/EVN"); e.printStackTrace(); }

//*************************
//DISCHARGE DISPOSITION CODE MAPPING
//  PV1-36 -->> PV1-36
//*************************
Field DischDispField = pv1Segment.getField(36);
String DischDisp = DischDispField.get(1);
String newDisp = "";
try {
    if (DischDisp != null) {
        if (DischDisp.equalsIgnoreCase("1")) newDisp = "HOM";
        else if (DischDisp.equalsIgnoreCase("2")) newDisp = "E";
        else if (DischDisp.equalsIgnoreCase("3")) newDisp = "STH";
        else if (DischDisp.equalsIgnoreCase("4")) newDisp = "SNF";
        else if (DischDisp.equalsIgnoreCase("5")) newDisp = "ICF";
        else if (DischDisp.equalsIgnoreCase("6")) newDisp = "OTH";
        else if (DischDisp.equalsIgnoreCase("7")) newDisp = "HHS";
        else if (DischDisp.equalsIgnoreCase("8")) newDisp = "AMA";
        else if (DischDisp.equalsIgnoreCase("9")) newDisp = "HIS";
        else if (DischDisp.equalsIgnoreCase(" ")) newDisp = "PAT";
        else if (DischDisp.equalsIgnoreCase("A")) newDisp = "AIP";
        else if (DischDisp.equalsIgnoreCase("B")) newDisp = "HPH";
        else if (DischDisp.equalsIgnoreCase("C")) newDisp = "SWB";
        else if (DischDisp.equalsIgnoreCase("D")) newDisp = "RFU";
        else if (DischDisp.equalsIgnoreCase("E")) newDisp = "LTH";
        else if (DischDisp.equalsIgnoreCase("F")) newDisp = "OSO";
        else if (DischDisp.equalsIgnoreCase("G")) newDisp = "OST";
        else newDisp = "";
    }
} catch (Exception e)
{ log.error("Exception in mapping Discharge Disposition"); e.printStackTrace(); }
Field f = new Field(newDisp);
pv1Segment.setField(36,f);

//*************************
//PATIENT STATUS MAPPING : EVN-1 -->> PV1-41
//*************************
String mappedPatientStatus = "";
try {
    if (eventTypeCode != null) {
        if (eventTypeCode.equalsIgnoreCase("A01")) mappedPatientStatus = "ADM";
        else if (eventTypeCode.equalsIgnoreCase("A02")) mappedPatientStatus =  "LTP";
        else if (eventTypeCode.equalsIgnoreCase("A03")) mappedPatientStatus = "DIS";
        else if (eventTypeCode.equalsIgnoreCase("A04")) mappedPatientStatus = "REG";
        else if (eventTypeCode.equalsIgnoreCase("A05")) mappedPatientStatus = "PRE";
        else if (eventTypeCode.equalsIgnoreCase("A06")) mappedPatientStatus = "ADM";
        else if (eventTypeCode.equalsIgnoreCase("A07")) mappedPatientStatus = "REG";
        else if (eventTypeCode.equalsIgnoreCase("A08")) mappedPatientStatus = "LTP";
        else if (eventTypeCode.equalsIgnoreCase("A09")) mappedPatientStatus = "";
        else if (eventTypeCode.equalsIgnoreCase("A11")) mappedPatientStatus = "LTP";
        else if (eventTypeCode.equalsIgnoreCase("A12")) mappedPatientStatus = "";
        else if (eventTypeCode.equalsIgnoreCase("A13")) mappedPatientStatus = "LTP";
        else if (eventTypeCode.equalsIgnoreCase("A17")) mappedPatientStatus = "LTP";
        else if (eventTypeCode.equalsIgnoreCase("A18")) mappedPatientStatus = "LTP";
        else mappedPatientStatus = "";
        log.info("EventTypeCode : [" + eventTypeCode + "]" + " >> PatientStatus : [" + mappedPatientStatus + "]");
    } else {
        mappedPatientStatus = "";
    }
    Field f = new Field(mappedPatientStatus);
    pv1Segment.setField(41,f);
} catch (Exception e)
{ log.error("Exception in mapping Patient Status"); e.printStackTrace(); }

//*************************
//PATIENT TYPE MAPPING : PV1-18 -->> PV1-18
//*************************
String mappedPatientType = "";
try {
    if (originalPatientType != null) {
        if (originalPatientType.equalsIgnoreCase("B")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("O")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("P")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("T")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("V")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("B")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("W")) mappedPatientType = "CLI";
        else if (originalPatientType.equalsIgnoreCase("E")) mappedPatientType = "ER";
        else if (originalPatientType.equalsIgnoreCase("I")) mappedPatientType = "IN";
        else if (originalPatientType.equalsIgnoreCase("N")) mappedPatientType = "IN";
        else if (originalPatientType.equalsIgnoreCase("D")) mappedPatientType = "INO";
        else if (originalPatientType.equalsIgnoreCase("R")) mappedPatientType = "RCR";
        else if (originalPatientType.equalsIgnoreCase("A")) mappedPatientType = "REF";
        else if (originalPatientType.equalsIgnoreCase("X")) mappedPatientType = "REF";
        else if (originalPatientType.equalsIgnoreCase("S")) mappedPatientType = "SDC";
        else mappedPatientType = "";
        log.info("PatientType : [" + originalPatientType + "]" + " >> MappedPatientType : [" + mappedPatientType + "]");
    } else {
        mappedPatientType = "";
    }
    Field f=new Field(mappedPatientType);
    pv1Segment.setField(18,f);
} catch (Exception e)
{ log.error("Exception in mapping Patient Type"); e.printStackTrace(); }

Field location = pv1Segment.getField(3);
location.set(1,4,"ACH");
Field lf = new Field("ACH");
pv1Segment.setField(39,lf);

Field identifier = pidSegment.getField(3);
String medRecNumber = null;
if (identifier != null) {
    medRecNumber = identifier.get(1,1);
}

String newMedRecNumber = "";
if (medRecNumber != null) {
    String[] pcsMR = medRecNumber.split("-");
    for (int i=0; i != pcsMR.length; i++)  //a less-than sign does not work here (xml)!
        newMedRecNumber += pcsMR[i];
} else {
    newMedRecNumber = "";
}

Field newIdentifier = new Field(newMedRecNumber);
pidSegment.setField(3,newIdentifier);

//*************************
//RELATIONSHIP MAPPING : Guarantor GT1-11
//*************************
if (gt1Segment != null) {
    Field relationshipField = gt1Segment.getField(11);
    String relationship = relationshipField.get(1);
    String mappedRelationship = "";
    try {
        if (relationship != null) {
            if (relationship.equalsIgnoreCase("O")) mappedRelationship = "AU";
            else if (relationship.equalsIgnoreCase("G")) mappedRelationship = "BR";
            else if (relationship.equalsIgnoreCase("J")) mappedRelationship = "DA";
            else if (relationship.equalsIgnoreCase("Y")) mappedRelationship = "EM";
            else if (relationship.equalsIgnoreCase("E")) mappedRelationship = "FA";
            else if (relationship.equalsIgnoreCase("Z")) mappedRelationship = "FO";
            else if (relationship.equalsIgnoreCase("Y")) mappedRelationship = "FR";
            else if (relationship.equalsIgnoreCase("2")) mappedRelationship = "GD";
            else if (relationship.equalsIgnoreCase("L")) mappedRelationship = "GF";
            else if (relationship.equalsIgnoreCase("K")) mappedRelationship = "GM";
            else if (relationship.equalsIgnoreCase("1")) mappedRelationship = "GS";
            else if (relationship.equalsIgnoreCase("C")) mappedRelationship = "HU";
            else if (relationship.equalsIgnoreCase("X")) mappedRelationship = "LP";
            else if (relationship.equalsIgnoreCase("B")) mappedRelationship = "MD";
            else if (relationship.equalsIgnoreCase("F")) mappedRelationship = "MO";
            else if (relationship.equalsIgnoreCase("N")) mappedRelationship = "SF";
            else if (relationship.equalsIgnoreCase("H")) mappedRelationship = "SI";
            else if (relationship.equalsIgnoreCase("M")) mappedRelationship = "SM";
            else if (relationship.equalsIgnoreCase("I")) mappedRelationship = "SO";
            else if (relationship.equalsIgnoreCase("A")) mappedRelationship = "SP";
            else if (relationship.equalsIgnoreCase("P")) mappedRelationship = "UN";
            else if (relationship.equalsIgnoreCase("D")) mappedRelationship = "WI";
            else mappedRelationship = "";
            log.info("GUARANTOR relationship : [" + relationship + "]" + " >> mappedRelationship : [" + mappedRelationship + "]");
        } else {
            mappedRelationship = "";
        }
        Field f=new Field(mappedRelationship);
        gt1Segment.setField(11,f);
    } catch (Exception e)
    { log.error("Exception in mapping Guarantor Relationship GT1-11"); e.printStackTrace(); }
}

//*************************
//RACE MAPPING : Patient Race PID-10
//*************************
Field raceField = pidSegment.getField(10);
String race = raceField.get(1);
String mappedRace = "";
try {
    if (race != null) {
        if (race.equalsIgnoreCase("A")) mappedRace = "AS";
        else if (race.equalsIgnoreCase("B")) mappedRace = "AA";
        else if (race.equalsIgnoreCase("C")) mappedRace = "CA";
        else if (race.equalsIgnoreCase("H")) mappedRace = "HI";
        else if (race.equalsIgnoreCase("I")) mappedRace = "NA";
        else if (race.equalsIgnoreCase("M")) mappedRace = "HI";
        else if (race.equalsIgnoreCase("O")) mappedRace = "OT";
        else if (race.equalsIgnoreCase("U")) mappedRace = "OT";
        else if (race.equalsIgnoreCase("W")) mappedRace = "CA";
        else mappedRace = "";
        log.info("PATIENT race : [" + race + "]" + " >> mappedRace : [" + mappedRace + "]");
    } else {
        mappedRace = "";
    }
    Field f=new Field(mappedRace);
    pidSegment.setField(10,f);
} catch (Exception e)
{ log.error("Exception in mapping Patient Race PID-10"); e.printStackTrace(); }

//*************************
//ADMIT SOURCE MAPPING : PV1-14
//*************************
Field admitSourceField = pv1Segment.getField(14);
String admitSource = admitSourceField.get(1);
String mappedAdmitSource = "";
try {
    if (admitSource != null) {
        if (admitSource.equalsIgnoreCase("2")) mappedAdmitSource = "CLI";
        else if (admitSource.equalsIgnoreCase("7")) mappedAdmitSource = "EMR";
        else if (admitSource.equalsIgnoreCase("3")) mappedAdmitSource = "HMO";
        else if (admitSource.equalsIgnoreCase("8")) mappedAdmitSource = "LAW";
        else if (admitSource.equalsIgnoreCase("1")) mappedAdmitSource = "PHY";
        else if (admitSource.equalsIgnoreCase("4")) mappedAdmitSource = "TAC";
        else if (admitSource.equalsIgnoreCase("6")) mappedAdmitSource = "TOT";
        else if (admitSource.equalsIgnoreCase("5")) mappedAdmitSource = "TSN";
        else if (admitSource.equalsIgnoreCase("9")) mappedAdmitSource = "UNK";
        else mappedAdmitSource = "";
        log.info("admitSource : [" + admitSource + "]" + " >> mappedAdmitSource : [" + mappedAdmitSource + "]");
    } else {
        mappedAdmitSource = "";
    }
    Field f=new Field(mappedAdmitSource);
    pv1Segment.setField(14,f);
} catch (Exception e)
{ log.error("Exception in mapping admitSource PV1-14"); e.printStackTrace(); }

//*************************
//ADMIT PRIORITY MAPPING : PV1-4
//*************************
Field admitPriorityField = pv1Segment.getField(4);
String admitPriority = admitPriorityField.get(1);
String mappedAdmitPriority = "";
try {
    if (admitPriority != null) {
        if (admitPriority.equalsIgnoreCase("3")) mappedAdmitPriority = "EL";
        else if (admitPriority.equalsIgnoreCase("1")) mappedAdmitPriority = "ER";
        else if (admitPriority.equalsIgnoreCase("9")) mappedAdmitPriority = "NA";
        else if (admitPriority.equalsIgnoreCase("4")) mappedAdmitPriority = "NB";
        else if (admitPriority.equalsIgnoreCase("2")) mappedAdmitPriority = "UR";
        else mappedAdmitPriority = "";
        log.info("admitPriority : [" + admitPriority + "]" + " >> mappedAdmitPriority : [" + mappedAdmitPriority + "]");
    } else {
        mappedAdmitPriority = "";
    }
    Field f=new Field(mappedAdmitPriority);
    pv1Segment.setField(4,f);
} catch (Exception e)
{ log.error("Exception in mapping admitPriority PV1-4"); e.printStackTrace(); }

//*************************
//FINANCIAL CLASS MAPPING : PV1-20
//*************************
Field financialClassField = pv1Segment.getField(20);
String financialClass = financialClassField.get(1);
financialClass = financialClass.substring(0,2);
String mappedFinancialClass = "";
try {
    if (financialClass != null) {
        if (financialClass.equalsIgnoreCase("00")) mappedFinancialClass = "SP";
        else if (financialClass.equalsIgnoreCase("10")) mappedFinancialClass = "CO";
        else if (financialClass.equalsIgnoreCase("11")) mappedFinancialClass = "CO";
        else if (financialClass.equalsIgnoreCase("12")) mappedFinancialClass = "U";
        else if (financialClass.equalsIgnoreCase("15")) mappedFinancialClass = "CO";
        else if (financialClass.equalsIgnoreCase("20")) mappedFinancialClass = "BC";
        else if (financialClass.equalsIgnoreCase("25")) mappedFinancialClass = "CO";
        else if (financialClass.equalsIgnoreCase("30")) mappedFinancialClass = "MCRA";
        else if (financialClass.equalsIgnoreCase("40")) mappedFinancialClass = "CH";
        else if (financialClass.equalsIgnoreCase("45")) mappedFinancialClass = "MCAL";
        else if (financialClass.equalsIgnoreCase("50")) mappedFinancialClass = "MCD";
        else if (financialClass.equalsIgnoreCase("61")) mappedFinancialClass = "MVA";
        else if (financialClass.equalsIgnoreCase("71")) mappedFinancialClass = "IND";
        else if (financialClass.equalsIgnoreCase("80")) mappedFinancialClass = "SP";
        else if (financialClass.equalsIgnoreCase("90")) mappedFinancialClass = "OT";
        else mappedFinancialClass = "";
        log.info("financialClass : [" + financialClass + "]" + " >> mappedFinancialClass : [" + mappedFinancialClass + "]");
    } else {
        mappedFinancialClass = "";
    }
    Field f=new Field(mappedFinancialClass);
    pv1Segment.setField(20,f);
} catch (Exception e)
{ log.error("Exception in mapping financialClass PV1-20"); e.printStackTrace(); }

//*************************
//PATIENT TYPE TO LOCATION MAPPING : PV1-18 -->> PV1-3
//*************************
if ((originalPatientType != null) &amp;&amp; (originalPatientType.equalsIgnoreCase("P"))) {
    mappedLocation = "PREOP";
    log.info("patientType : [" + originalPatientType + "]" + " >> mappedLocation : [" + mappedLocation + "]");
    Field f=new Field(mappedLocation);
    pv1Segment.setField(3,f);
}

//*************************
//SERVICE CODE TO LOCATION MAPPING : PV1-10 -->> PV1-3
//*************************
Field serviceCodeField = pv1Segment.getField(10);
String serviceCode = serviceCodeField.get(1);
String patientType = originalPatientType;
Field locationField = pv1Segment.getField(3);
String mappedLocation = "";
try {
    //if LOCATION is empty, then grab the service code and stick it in
    if (locationField != null) {
        if (locationField.toString().equals("") == true) {
            if (serviceCode != null) {
                if (serviceCode.equalsIgnoreCase("EMR")) mappedLocation = "ER";
                else if (serviceCode.equalsIgnoreCase("CTS")) mappedLocation = "CT";
                else if (serviceCode.equalsIgnoreCase("RAD")) mappedLocation = "RAD";
                else if (serviceCode.equalsIgnoreCase("SDS")) mappedLocation = "SDS";
                else if (serviceCode.equalsIgnoreCase("LAB")) mappedLocation = "LAB";
                else if (serviceCode.equalsIgnoreCase("PHT")) mappedLocation = "PT";
                else if (serviceCode.equalsIgnoreCase("DEP")) mappedLocation = "DEP";
                else if (serviceCode.equalsIgnoreCase("DIT")) mappedLocation = "DIT";
                else if (serviceCode.equalsIgnoreCase("PHT")) mappedLocation = "PT";
                else if (serviceCode.equalsIgnoreCase("SPS")) mappedLocation = "SPS";
                else if (serviceCode.equalsIgnoreCase("SPT")) mappedLocation = "SPT";
                else if (serviceCode.equalsIgnoreCase("OBN")) mappedLocation = "OBN";
                else if (serviceCode.equalsIgnoreCase("OHD")) mappedLocation = "OHD";
                else if (serviceCode.equalsIgnoreCase("OCT")) mappedLocation = "OT";
                else if (serviceCode.equalsIgnoreCase("ORT")) mappedLocation = "ORTHO";
                else if (serviceCode.equalsIgnoreCase("PUL")) mappedLocation = "RT";
                else if (serviceCode.equalsIgnoreCase("WND")) mappedLocation = "WND";
                else if (serviceCode.equalsIgnoreCase("RST")) mappedLocation = "RT";
                else if (serviceCode.equalsIgnoreCase("SUR")) mappedLocation = "SDS";
                else if (serviceCode.equalsIgnoreCase("MED")) mappedLocation = "MS1";
                else if (serviceCode.equalsIgnoreCase("OBS")) mappedLocation = "OBS";
                else mappedLocation = "";
                log.info("serviceCode : [" + serviceCode + "]" + " >> mappedLocation : [" + mappedLocation + "]");
            }
            
            if ((patientType != null) &amp;&amp; (patientType.equalsIgnoreCase("H"))) {
                mappedLocation = "HH";
                log.info("patientType : [" + patientType + "]" + " >> mappedLocation : [" + mappedLocation + "]");
            }
            else if ((patientType != null) &amp;&amp; (patientType.equalsIgnoreCase("T"))) {
                mappedLocation = "ER";
                log.info("patientType : [" + patientType + "]" + " >> mappedLocation : [" + mappedLocation + "]");
            }
            else if ((patientType != null) &amp;&amp; (patientType.equalsIgnoreCase("V"))) {
                mappedLocation = "SPS";
                log.info("patientType : [" + patientType + "]" + " >> mappedLocation : [" + mappedLocation + "]");
            }
            
            if ((patientType != null) &amp;&amp; patientType.equalsIgnoreCase("O"))
                if ((serviceCode != null) &amp;&amp; serviceCode.equalsIgnoreCase("OPR"))
                    mappedLocation = "PHA";
            
            Field f=new Field(mappedLocation);
            pv1Segment.setField(3,f);
        }
    }
} catch (Exception e)
{ log.error("Exception in mapping location PV1-3"); e.printStackTrace(); }

//*************************
//ACCOUNT NUMBER + MEDICAL RECORD NUMBER MAPPING : PID-3,PID-18,MRG-3
//*************************
Field identifier = pidSegment.getField(3);
if (identifier != null) {
    String medRecNumber = identifier.get(1,1);
    if (medRecNumber != null) {
        Field newIdentifier = new Field("M" + medRecNumber);
        pidSegment.setField(3,newIdentifier);
    }
}

Field accountNumberField = pidSegment.getField(18);

//** NEW CODE to handle EMPTY ACCOUNT NUMBER FIELDS in A31 messages
//** 02/26/04 by jacek zagorski, shasta networks
if ((accountNumberField != null) &amp;&amp;
((accountNumberField.get(1)).equals("") != true))
{
	String accountNumber = accountNumberField.get(1);
	Field newAccountNumber = new Field("V" + accountNumber);
	pidSegment.setField(18,newAccountNumber);
}
//** NEW CODE to handle EMPTY ACCOUNT NUMBER FIELDS in A31 messages
//** 02/26/04 by jacek zagorski, shasta networks

if (mrgSegment != null) {
    Field accountNumberMRGField= mrgSegment.getField(3);
    if (accountNumberMRGField != null) {
        String accountNumberMRG = accountNumberMRGField.get(1);
        if (accountNumberMRG != null) {
            Field f=new Field("V" + accountNumberMRG);
            mrgSegment.setField(3,f);
        }
    }
}

//*************************
//VIP MAPPING : PV1-16, if 1,2,3,4, change to "Y", otherwise BLANK
//*************************
Field vipField = pv1Segment.getField(16);
if (vipField != null) {
    String vip = vipField.get(1,1);
    if (vip != null) {
        if ((vip.equals("1") == true) || (vip.equals("2") == true) || (vip.equals("3") == true) || (vip.equals("4") == true)) {
            Field newVip = new Field("Y");
            pv1Segment.setField(16,newVip);
        }
        else {
            Field newVip = new Field("");
            pv1Segment.setField(16,newVip);
        }
    }
}
                     
      	</attribute>
   </mbean>

   <mbean code="org.jengine.mbean.HL7XformService" name="JEngine:service=Interface,name=XFORM_CHG_MT_MS4">
        <attribute name="IFName">XFORM_CHG_MT_MS4</attribute>
       	<attribute name="InQueue">Q_IN_HL7_MT_MS4_CHG</attribute>
       	<attribute name="OutQueue">Q_OUT_HL7_MT_MS4_CHG</attribute>
        <attribute name="Transformation">org.jengine.internal.bsh.Transformation</attribute>
        <attribute name="TransformationProperties">
           import org.jengine.tools.hl7.Segment;
           import org.jengine.tools.hl7.Field;
	   log.info("transformation in progress");
	   log.info("version is "+message.versionID);
           Segment fhsSegment = message.getSegment("FHS");
           log.info("message.getSegment(FHS)");
           Segment ftsSegment = message.getSegment("FTS");
           log.info("message.getSegment(FTS)");
           message.removeSegment(ftsSegment);
           log.info("---FTS Segment Removed");
           message.removeSegment(fhsSegment);
           log.info("---FHS Segment Removed");
           
           //SET BHS SEGMENT FIELDS
           Segment bhsSegment = message.getSegment("BHS");
           Segment btsSegment = message.getSegment("BTS");
           Field fac = new Field("500");  //facilities
           Field app = new Field("MS4AR");//sending application
           bhsSegment.setField(3,fac);
           bhsSegment.setField(4,app);
           bhsSegment.setField(5,fac);
           Field batchType = new Field("C");
           bhsSegment.setField(8,batchType);
           Field batchControlId = new Field("");
           bhsSegment.setField(11,batchControlId);
           
           Field empty = new Field("");
           btsSegment.setField(2,empty);
           btsSegment.setField(3,empty);
           btsSegment.setField(3,empty);

           java.util.Vector mshSegs = new Vector();
           mshSegs = message.getSegments("MSH");
           log.info("Got mshSegs : insert facilities, sending application");
           for(java.util.Iterator it=mshSegs.iterator(); it.hasNext(); )
           {
               Segment seg=(Segment)it.next();
               Field fac = new Field("500");  //facilities
               Field app = new Field("MS4AR");//sending application
               seg.setField(4,fac);
               seg.setField(5,app);
               seg.setField(6,fac);
               Field msh9 = new Field("DFT^P03");
               seg.setField(9,msh9);
           }

           java.util.Vector pidSegs = new Vector();
           pidSegs = message.getSegments("PID");
           log.info("Got pidSegs : filter mr#, acct # : pid-3, pid-18");
           for(java.util.Iterator it2=pidSegs.iterator(); it2.hasNext(); )
           {
               Segment seg=(Segment)it2.next();
	       Field medRecNumberField = seg.getField(3);
               String medRecNumber = medRecNumberField.get(1,1);
               Field accountNumberField = seg.getField(18);
               String accountNumber = accountNumberField.get(1);
               if (accountNumber.startsWith("V") == true)
               {
                    String newAccountNumber = accountNumber.substring(1);
                    Field f = new Field(newAccountNumber);
                    seg.setField(18,f);
               }
               if (medRecNumber.startsWith("M") == true)
               {
                    String newMedRecNumber = medRecNumber.substring(1);
                    Field f = new Field(newMedRecNumber);
                    seg.setField(3,f);
               }
               if (medRecNumber.startsWith("M000") == true)
               {
                    String newMedRecNumber = medRecNumber.substring(4);
                    Field f = new Field(newMedRecNumber);
                    seg.setField(3,f);
               }
           }

           java.util.Vector ft1Segs = new Vector();
           ft1Segs = message.getSegments("FT1");
           log.info("Got " + ft1Segs.size() + " ft1Segs : insert corrected batch ID");
           for(java.util.Iterator it3=ft1Segs.iterator(); it3.hasNext(); )
           {
               Segment seg=(Segment)it3.next();
	       Field batchIdField = seg.getField(3);
	       String batchId = batchIdField.get(1,1);
	       String regexStr = "\\.";
	       String[] piecesBatchId = batchId.split(regexStr);
	       String newBatchId = "";
	       String newBatchNumber = "";
	       if (piecesBatchId[1].length() > 2)
	       		newBatchNumber = piecesBatchId[1].substring(2); //takes substring starting at position 2
		else if (piecesBatchId[1].length() == 0)
			newBatchNumber = "01";
		else
			newBatchNumber = piecesBatchId[1];
	       newBatchId = piecesBatchId[0] + newBatchNumber;
	       Field bIdField = new Field(newBatchId);
               seg.setField(3,bIdField);
               //blank out the extended amount field.
	       Field amountField = new Field("");
               seg.setField(11,amountField);
           }
//**************************************
//BHS-6 Date Mapping to one day before
//**************************************
Field BatchCreateDateField = bhsSegment.getField(6);
String BatchCreateDate = BatchCreateDateField.get(1);
log.debug(">>>>>>>>>>>>>>>>>>>>>>> 1 BatchCreateDate : " + BatchCreateDate);
BatchCreateDate = BatchCreateDate.substring(0,8);
log.debug(">>>>>>>>>>>>>>>>>>>>>>> 2 BatchCreateDate : " + BatchCreateDate);
String mappedBatchCreateDate = "";
try {
    if (BatchCreateDate != null) {
    if (BatchCreateDate.equalsIgnoreCase("20040602")) mappedBatchCreateDate = "200406010001";
    else if (BatchCreateDate.equalsIgnoreCase("20040603")) mappedBatchCreateDate = "200406020001";
    else if (BatchCreateDate.equalsIgnoreCase("20040604")) mappedBatchCreateDate = "200406030001";
    else if (BatchCreateDate.equalsIgnoreCase("20040605")) mappedBatchCreateDate = "200406040001";
    else if (BatchCreateDate.equalsIgnoreCase("20040606")) mappedBatchCreateDate = "200406050001";
    else if (BatchCreateDate.equalsIgnoreCase("20040607")) mappedBatchCreateDate = "200406060001";
    else if (BatchCreateDate.equalsIgnoreCase("20040608")) mappedBatchCreateDate = "200406070001";
    else if (BatchCreateDate.equalsIgnoreCase("20040609")) mappedBatchCreateDate = "200406080001";
    else if (BatchCreateDate.equalsIgnoreCase("20040610")) mappedBatchCreateDate = "200406090001";
    else if (BatchCreateDate.equalsIgnoreCase("20040611")) mappedBatchCreateDate = "200406100001";
    else if (BatchCreateDate.equalsIgnoreCase("20040612")) mappedBatchCreateDate = "200406110001";
    else if (BatchCreateDate.equalsIgnoreCase("20040613")) mappedBatchCreateDate = "200406120001";
    else if (BatchCreateDate.equalsIgnoreCase("20040614")) mappedBatchCreateDate = "200406130001";
    else if (BatchCreateDate.equalsIgnoreCase("20040615")) mappedBatchCreateDate = "200406140001";
    else if (BatchCreateDate.equalsIgnoreCase("20040616")) mappedBatchCreateDate = "200406150001";
    else if (BatchCreateDate.equalsIgnoreCase("20040617")) mappedBatchCreateDate = "200406160001";
    else if (BatchCreateDate.equalsIgnoreCase("20040618")) mappedBatchCreateDate = "200406170001";
    else if (BatchCreateDate.equalsIgnoreCase("20040619")) mappedBatchCreateDate = "200406180001";
    else if (BatchCreateDate.equalsIgnoreCase("20040620")) mappedBatchCreateDate = "200406190001";
    else if (BatchCreateDate.equalsIgnoreCase("20040621")) mappedBatchCreateDate = "200406200001";
    else if (BatchCreateDate.equalsIgnoreCase("20040622")) mappedBatchCreateDate = "200406210001";
    else if (BatchCreateDate.equalsIgnoreCase("20040623")) mappedBatchCreateDate = "200406220001";
    else if (BatchCreateDate.equalsIgnoreCase("20040624")) mappedBatchCreateDate = "200406230001";
    else if (BatchCreateDate.equalsIgnoreCase("20040625")) mappedBatchCreateDate = "200406240001";
    else if (BatchCreateDate.equalsIgnoreCase("20040626")) mappedBatchCreateDate = "200406250001";
    else if (BatchCreateDate.equalsIgnoreCase("20040627")) mappedBatchCreateDate = "200406260001";
    else if (BatchCreateDate.equalsIgnoreCase("20040628")) mappedBatchCreateDate = "200406270001";
    else if (BatchCreateDate.equalsIgnoreCase("20040629")) mappedBatchCreateDate = "200406280001";
    else if (BatchCreateDate.equalsIgnoreCase("20040630")) mappedBatchCreateDate = "200406290001";
    else if (BatchCreateDate.equalsIgnoreCase("20040701")) mappedBatchCreateDate = "200406300001";
    else mappedBatchCreateDate = "";
    }
    Field f=new Field(mappedBatchCreateDate);
    bhsSegment.setField(6,f);
    } catch (Exception e)
    { log.error("**BAD BHS-6 DATE**"); }
//**************************************
//Added by Randy Romanoff on 06/11/04
//**************************************
	</attribute>
   </mbean>
</server>
